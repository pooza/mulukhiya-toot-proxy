doctype html
html lang='ja' data-theme='light'
  head
    == slim.render 'fragment/metadata'
    == slim.render 'fragment/assets'
  body
    == slim.render 'fragment/header'
    == slim.render 'fragment/breadcrumbs', {entries: [{label: 'モロヘイヤHOME', href: '/mulukhiya'}, {label: 'トークンの管理', href: '/mulukhiya/app/token'}, {label: '認証完了'}]}
    main#app v-cloak='' class=env.type
      == slim.render 'fragment/message'
      h2 認証完了
      .field-update-button-container v-if='restartable'
        button v-if='account.is_admin' @click='restartPuma' 再起動
        p.alert トークンの更新を反映するには再起動が必要です。
        p.alert v-if='account.is_admin' 再起動している間（数十秒程度）は操作できなくなります。
        p.alert v-else='' 管理者に再起動を依頼してください。
      .description v-if='registered' トークンの登録が完了しました。
      .description v-else='' トークンを登録しています...
      nav.tokens v-if='account.username'
        .token
          .field
            .title アカウント
            .value @{{account.username}}
      p
        a href='/mulukhiya/app/token' トークンの管理に戻る
    == slim.render 'fragment/footer'
    script type='module'
      |
        import { createApp } from 'vue'
        import { MulukhiyaLib } from 'mulukhiya_lib'
        import { SlideUpDown } from 'slide_toggle'
        import { VTooltip } from 'v_tooltip'
        import Swal from 'sweetalert2'
        const app = createApp({
          data () {
            return {
              account: {},
              registered: false,
              restartable: false,
            }
          },
          async created () {
            const params = new URLSearchParams(window.location.search)
            const token = params.get('token')
            if (token) {
              this.methods.registerToken(token)
                .then(e => {
                  this.account = e
                  this.registered = true
                  this.restartable = true
                }).catch(e => Swal.fire({text: e.message, icon: 'error'}))
            }
          },
          methods: {
            restartPuma () {
              Swal.fire({
                title: 'Pumaの再起動',
                text: 'Pumaを再起動します。',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '再起動',
                cancelButtonText: 'キャンセル',
              }).then(result => {
                if (!result.isConfirmed) return
                this.methods.restartPuma().then(_ => {
                  this.restartable = false
                  Swal.fire({
                    title: '再起動中',
                    text: 'しばらくお待ちください...',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => Swal.showLoading(),
                  })
                  this.methods.waitForHealth().then(_ => {
                    Swal.fire({title: '再起動完了', icon: 'success', timer: 2000, showConfirmButton: false})
                      .then(_ => location.reload())
                  }).catch(e => Swal.fire({title: '再起動エラー', text: e.message, icon: 'error'}))
                })
              }).catch(e => Swal.fire({text: e.message, icon: 'error'}))
            },
          },
        })
        app.use(MulukhiyaLib)
        app.component('slide-up-down', SlideUpDown)
        app.directive('tooltip', VTooltip)
        app.mount('#app')
